- name: Install postgresql-common
  apt:
    state: present
    name:
      - postgresql-common
    update_cache: yes
  become: yes

- name: Disable create_main_cluster
  lineinfile:
    path: /etc/postgresql-common/createcluster.conf
    line: create_main_cluster = false
    create: yes
  become: yes

- name: Give {{ postgres.user }} ownership of {{ postgres.config_base_dir }}
  file:
    path: "{{ postgres.config_base_dir }}"
    owner: "{{ postgres.user }}"
    group: "{{ postgres.group }}"
    mode: 0750
  become: yes

- name: Ensure stats_temp_directory exists
  file:
    state: directory
    path: /var/run/postgresql/{{ postgres.version }}-{{ postgres.cluster }}.pg_stat_tmp
    owner: "{{ postgres.user }}"
    group: "{{ postgres.group }}"
    mode: "2750"
  become: yes

- name: Ensure {{ postgres.config_dir }}/conf.d exists
  file:
    state: directory
    path: "{{ postgres.config_dir }}/conf.d"
    owner: "{{ postgres.user }}"
    group: "{{ postgres.group }}"
    mode: 0750
  become: yes

- name: Install postgresql-{{ postgres.version }}
  apt:
    state: present
    name:
      - postgresql-{{ postgres.version }}
      - postgresql-server-dev-{{ postgres.version }}
    update_cache: yes
  become: yes

- name: Install Python and friends
  apt:
    state: present
    name:
      - "{{ python.basename }}-dev"
      - "{{ python.basename }}-pip"
      - "{{ python.basename }}-psycopg2"
    update_cache: yes
  become: yes

- name: Install virtualenv by pip
  pip:
    state: present
    name: virtualenv
    executable: "{{ python.pip.basename }}"
  become: yes

- name: Install patroni and friends
  pip:
    state: present
    name:
      - psycopg2-binary
      - patroni[raft]
    virtualenv: "{{ patroni.venv_dir }}"
    virtualenv_python: "{{ python.binary }}"
  become: yes
